{% extends "base.html" %}

{% block title %}{{ restaurant.name }} - JustEat Technology{% endblock %}

{% block extra_css %}
<style>
.page-background {
    position: relative;
    min-height: 100vh;
    background-image: url('{{ url_for('static', filename='images/header-bg.jpg') }}');
    background-size: cover;
    background-position: center;
    background-attachment: fixed;
    margin: -20px -15px;
    padding: 20px 15px;
}

.page-background::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.75);
    z-index: 1;
}

.page-background .container {
    position: relative;
    z-index: 2;
}

.page-background .card {
    background-color: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(5px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
}
</style>
{% endblock %}

{% block content %}
<div class="page-background">
    <div class="container py-4">
    <!-- Restaurant Image Mapping -->
    {# Use centralized helper that checks uploaded files by slug #}
    
    <!-- Restaurant Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm overflow-hidden" style="position: relative; min-height: 200px;">
                <!-- Background Image -->
                <div class="restaurant-bg" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-image: url('{{ restaurant_image(restaurant.name) }}'); background-size: cover; background-position: center; z-index: 1;"></div>
                
                <!-- Gradient Overlay -->
                <div class="restaurant-overlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(180deg, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.7) 100%); z-index: 2;"></div>
                
                <!-- Content -->
                <div class="card-body d-flex align-items-center" style="position: relative; z-index: 3; color: white; min-height: 200px;">
                    <div class="row align-items-center w-100">
                        <div class="col-md-8">
                            <h1 class="display-6 fw-bold mb-2 text-white">{{ restaurant.name }}</h1>
                            <p class="mb-3" style="color: rgba(255,255,255,0.9);">{{ restaurant.description }}</p>
                            <div class="d-flex align-items-center mb-3">
                                <div class="rating-stars me-3" style="color: #ffc107;">
                                    {% for i in range(5) %}
                                        <i class="fas fa-star{% if i >= restaurant.rating %}-o{% endif %}"></i>
                                    {% endfor %}
                                    <span class="ms-2" style="color: rgba(255,255,255,0.8);">({{ restaurant.total_reviews }} reviews)</span>
                                </div>
                                <span class="badge me-2" style="background-color: rgba(255,255,255,0.2); color: white; backdrop-filter: blur(10px);">{{ restaurant.cuisine_type }}</span>
                            </div>
                            <div class="d-flex align-items-center" style="color: rgba(255,255,255,0.8);">
                                <i class="fas fa-map-marker-alt me-2"></i>
                                <span class="me-4">{{ restaurant.location }}</span>
                                <i class="fas fa-phone me-2"></i>
                                <span>{{ restaurant.phone }}</span>
                            </div>
                        </div>
                        <div class="col-md-4 text-md-end">
                            <a href="{{ url_for('customer.restaurants') }}" class="btn" style="background-color: #85AA4A; border-color: #85AA4A; color: white; box-shadow: 0 4px 15px rgba(133, 170, 74, 0.3);">
                                <i class="fas fa-arrow-left me-2"></i>Back to Restaurants
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- Menu Items -->
        <div class="col-lg-8">
            <!-- Filters -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body">
                    <form method="GET" class="row g-3">
                        <div class="col-md-3">
                            <label for="category" class="form-label">Category</label>
                            <select class="form-select" id="category" name="category">
                                <option value="">All Categories</option>
                                {% for category in categories %}
                                <option value="{{ category }}" {% if category_filter == category %}selected{% endif %}>
                                    {{ category }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="cuisine" class="form-label">Cuisine</label>
                            <select class="form-select" id="cuisine" name="cuisine">
                                <option value="">All Cuisines</option>
                                {% for cuisine in cuisine_types %}
                                <option value="{{ cuisine }}" {% if cuisine_filter == cuisine %}selected{% endif %}>
                                    {{ cuisine }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="price" class="form-label">Price Range</label>
                            <select class="form-select" id="price" name="price">
                                <option value="">All Prices</option>
                                <option value="low" {% if price_filter == 'low' %}selected{% endif %}>Under ₹500</option>
                                <option value="medium" {% if price_filter == 'medium' %}selected{% endif %}>₹500 - ₹1000</option>
                                <option value="high" {% if price_filter == 'high' %}selected{% endif %}>Over ₹1000</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="dietary" class="form-label">Dietary</label>
                            <select class="form-select" id="dietary" name="dietary">
                                <option value="">All Options</option>
                                <option value="vegetarian" {% if dietary_filter == 'vegetarian' %}selected{% endif %}>Vegetarian</option>
                                <option value="vegan" {% if dietary_filter == 'vegan' %}selected{% endif %}>Vegan</option>
                                <option value="gluten_free" {% if dietary_filter == 'gluten_free' %}selected{% endif %}>Gluten Free</option>
                            </select>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Menu Items Grid -->
            <div class="row g-4">
                {% for item in menu_items %}
                <div class="col-md-6">
                    <div class="card menu-item-card h-100 border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="card-title mb-0">{{ item.name }}</h6>
                                <div>
                                    {% if item.is_special %}
                                    <span class="badge bg-danger me-1">Special</span>
                                    {% endif %}
                                    {% if item.is_deal_of_day %}
                                    <span class="badge bg-success me-1">Deal</span>
                                    {% endif %}
                                    {% if item.is_mostly_ordered() %}
                                    <span class="badge bg-warning text-dark">Mostly Ordered</span>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <p class="card-text text-muted small mb-3">{{ item.description }}</p>
                            
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <span class="fw-bold fs-5" style="color: #85AA4A;">₹{{ "%.2f"|format(item.price) }}</span>
                                    <small class="text-muted d-block">{{ item.category }}</small>
                                </div>
                                <div class="dietary-badges">
                                    {% if item.is_vegetarian %}
                                    <span class="badge bg-success me-1">Veg</span>
                                    {% endif %}
                                    {% if item.is_vegan %}
                                    <span class="badge bg-info me-1">Vegan</span>
                                    {% endif %}
                                    {% if item.is_gluten_free %}
                                    <span class="badge bg-warning text-dark">GF</span>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="d-flex align-items-center">
                                <div class="input-group me-3" style="width: 120px;">
                                    <button class="btn btn-outline-secondary btn-sm quantity-btn quantity-decrease" type="button">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <input type="number" class="form-control form-control-sm text-center" 
                                           id="quantity-{{ item.id }}" value="1" min="1" max="10">
                                    <button class="btn btn-outline-secondary btn-sm quantity-btn quantity-increase" type="button">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                                <button class="btn btn-sm add-to-cart-btn" 
                                        data-menu-item-id="{{ item.id }}"
                                        style="background-color: #85AA4A; border-color: #85AA4A; color: white;">
                                    <i class="fas fa-cart-plus me-1"></i>Add to Cart
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- No Menu Items -->
            {% if not menu_items %}
            <div class="text-center py-5">
                <i class="fas fa-utensils text-muted display-1 mb-3"></i>
                <h3 class="text-muted">No menu items found</h3>
                <p class="text-muted">Try adjusting your filters</p>
            </div>
            {% endif %}
        </div>
        
        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Reviews -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-star me-2" style="color: #85AA4A;"></i>Recent Reviews
                    </h5>
                    {% if can_review %}
                    <button class="btn btn-sm" id="add-review-btn" data-restaurant-id="{{ restaurant.id }}" style="background-color: #85AA4A; border-color: #85AA4A; color: white;">
                        <i class="fas fa-plus me-1"></i>Add Review
                    </button>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if reviews %}
                        {% for review in reviews %}
                        <div class="mb-3 pb-3 border-bottom">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="rating-stars">
                                    {% for i in range(5) %}
                                        <i class="fas fa-star{% if i >= review.rating %}-o{% endif %}"></i>
                                    {% endfor %}
                                </div>
                                <small class="text-muted">{{ review.created_at.strftime('%m/%d/%Y') }}</small>
                            </div>
                            <p class="small mb-1">{{ review.comment }}</p>
                            <small class="text-muted">- {{ review.user.first_name }}</small>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center text-muted small">No reviews yet.</div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Restaurant Info -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2" style="color: #85AA4A;"></i>Restaurant Info
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <strong>Cuisine Type:</strong>
                        <span class="badge bg-secondary ms-2">{{ restaurant.cuisine_type }}</span>
                    </div>
                    <div class="mb-3">
                        <strong>Location:</strong>
                        <p class="mb-0 text-muted">{{ restaurant.location }}</p>
                    </div>
                    <div class="mb-3">
                        <strong>Phone:</strong>
                        <p class="mb-0 text-muted">{{ restaurant.phone }}</p>
                    </div>
                    {% if restaurant.email %}
                    <div class="mb-3">
                        <strong>Email:</strong>
                        <p class="mb-0 text-muted">{{ restaurant.email }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Auto-submit form when filters change
$('.form-select').on('change', function() {
    $(this).closest('form').submit();
});

// Add review modal and submission
$('#add-review-btn').on('click', function() {
    const modalHtml = `
    <div class="modal fade" id="reviewModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add Review</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Rating</label>
              <select class="form-select" id="review-rating">
                <option value="5">5 - Excellent</option>
                <option value="4">4 - Good</option>
                <option value="3">3 - Average</option>
                <option value="2">2 - Poor</option>
                <option value="1">1 - Terrible</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Comment</label>
              <textarea class="form-control" id="review-comment" rows="3" placeholder="Share your experience..."></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" id="submit-review-btn">Submit</button>
          </div>
        </div>
      </div>
    </div>`;
    $('body').append(modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('reviewModal'));
    modal.show();
    $(document).on('click', '#submit-review-btn', function() {
        const rating = parseInt($('#review-rating').val());
        const comment = $('#review-comment').val().trim();
        const restId = $('#add-review-btn').data('restaurant-id');
        $.ajax({
            url: '/customer/add-review',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ restaurant_id: restId, rating: rating, comment: comment }),
            success: function(response) {
                if (response.success) {
                    showToast('success', response.message);
                    setTimeout(function() { location.reload(); }, 800);
                } else {
                    showToast('error', response.message);
                }
            },
            error: function() {
                showToast('error', 'An error occurred while adding review');
            }
        });
    });
});
</script>
{% endblock %}
